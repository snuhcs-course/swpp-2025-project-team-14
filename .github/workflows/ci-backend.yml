name: CI Pipeline for Backend

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      working-directory: ./backend
      JWT_SECRET: ${{ secrets.CI_JWT_SECRET }}
      DATABASE_URL: ${{ secrets.CI_DATABASE_URL }}
      DB_HOST: ${{ secrets.CI_DB_HOST }}
      DB_PORT: ${{ secrets.CI_DB_PORT }}
      DB_USER: ${{ secrets.CI_DB_USER }}
      DB_PASSWORD: ${{ secrets.CI_DB_PASSWORD }}
      DB_NAME: ${{ secrets.CI_DB_NAME }}
      AWS_ACCESS_KEY_ID: ${{ secrets.CI_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.CI_SECRET_ACCESS_KEY }}
      WEBHOOK_SECRET: ${{ secrets.CI_WEBHOOK_SECRET }}
      OPENAI_API_KEY: ${{ secrets.CI_OPENAI_API_KEY }}

    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install Poetry
        run: pip install poetry

      - name: âš™ï¸ Install Dependencies
        # ëŸ°íƒ€ì„ ì˜ì¡´ì„±ê³¼ dev ê·¸ë£¹ ì˜ì¡´ì„± ëª¨ë‘ ì„¤ì¹˜
        run: poetry install --with dev
        working-directory: ${{ env.working-directory }}
        
      # ----------------------------------------
      # 1. ë¦°íŠ¸ ì²´í¬ (Linting Check)
      # ----------------------------------------
      - name: âœ… Run Ruff (Linting Check)
        run: poetry run ruff check .
        working-directory: ${{ env.working-directory }}
      
      - name: âœ… Run Ruff (Format Check)
        run: poetry run ruff format --check
        working-directory: ${{ env.working-directory }}

      # ----------------------------------------
      # 2. í…ŒìŠ¤íŠ¸ (Pytest)
      # ----------------------------------------
      - name: ğŸ§ª Run Pytest
        run: poetry run pytest --cov=app --cov-report=term-missing tests/
        working-directory: ${{ env.working-directory }}

      # ----------------------------------------
      # 3. ë„ì»¤ ë¹Œë“œ ì²´í¬ (Docker Build Check)
      # ----------------------------------------
      - name: ğŸ³ Docker Build Check (Without Running)
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.working-directory }}
          push: false # ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œí•˜ì§€ ì•Šê³  ë¹Œë“œë§Œ ì²´í¬
          tags: mindlog:ci-check
          load: false # ì´ë¯¸ì§€ë¥¼ ë¡œì»¬ì— ë¡œë“œí•˜ì§€ ì•Šì•„ë„ ë¹Œë“œ ì„±ê³µ ì—¬ë¶€ëŠ” í™•ì¸ ê°€ëŠ¥