from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import PydanticOutputParser
from pydantic import BaseModel, Field
from typing import List
import re
from dotenv import load_dotenv

load_dotenv()
# -------------------------------
# 1️⃣ 파일 로드
# -------------------------------

def load_questions_with_keyed(path: str) -> list[str]:
    """
    questions.ts 파일에서 각 문항의 text와 keyed를 추출.
    text가 큰따옴표, 작은따옴표, 줄바꿈 포함해도 동작함.
    """
    with open(path, "r", encoding="utf-8") as f:
        text = f.read()

    # text: "..." or text: '...' (줄바꿈 포함 허용)
    texts = re.findall(r'text\s*:\s*[\'"]([^\'"]+)[\'"]', text)
    # keyed: 'plus' or "minus"
    keyeds = re.findall(r'keyed\s*:\s*[\'"](\w+)[\'"]', text)

    if len(texts) != len(keyeds):
        print(f"text({len(texts)})와 keyed({len(keyeds)}) 개수가 다릅니다!")

    results = [f"{t} (keyed: {k})" for t, k in zip(texts, keyeds)]
    return results


questions = load_questions_with_keyed("app/features/analysis/comprehensive_analysis/data/ko/questions.ts")

choices = """
각 문항에 대해 1부터 5까지의 5점 척도로 응답합니다.

각 문항의 방향(keyed)에 따라 선택 의미가 다릅니다.

keyed: plus
    1. 매우 그렇지 않다
    2. 그렇지 않다
    3. 보통이다
    4. 그렇다
    5. 매우 그렇다

keyed: minus
    (반대로 채점됩니다)
    1. 매우 그렇다
    2. 그렇다
    3. 보통이다
    4. 그렇지 않다
    5. 매우 그렇지 않다

즉, 'plus' 문항은 점수가 높을수록 해당 특성이 강하다는 뜻이며,
'minus' 문항은 점수가 높을수록 해당 특성이 약하다는 뜻입니다.
"""

print(f"Loaded {len(questions)} questions, choices")

# -------------------------------
# 2️⃣ LLM & Prompt 구성
# -------------------------------

template = """
당신은 심리분석 전문가입니다.
사용자의 일기 내용을 바탕으로 NEO-PI-R 형태의 20개 문항에 대해 답변을 예측하세요.

입력된 일기:
{conversation}

다음은 문항 응답에 대한 설명입니다:
{choices}

다음은 문항 목록입니다:
{questions}


각 문항에 대해 사용자가 답할 것으로 예상되는 가장 가능성 높은 응답(1~5)을 하나씩 예측하세요.
출력은 반드시 다음 구조를 따르세요:

각 문항에 대한 1~5의 정수값 리스트 (길이는 문항 수와 동일)
"""

prompt = ChatPromptTemplate.from_template(template)

class NeoPiAnswers(BaseModel):
    answers: List[int] = Field(
        description="각 문항(1~5 척도)에 대한 예측 응답 리스트. 길이는 질문 수와 동일해야 함."
    )

# # -------------------------------
# # 5️⃣ 예시 실행
# # -------------------------------

# if __name__ == "__main__":
#     sample_conversation = """
#     1. “오늘도 서버는 돌아간다”

#     오늘 서버가 또 죽었다. 로그를 뒤지고 원인을 찾는 동안, 내 머리도 같이 멈췄다. 해결하고 나니 팀장이 웃으며 “역시 도윤 씨”라고 했다. 기분이 나쁘지 않았는데, 동시에 이상하게 허무했다. 문제를 풀었는데, 내 인생의 버그는 그대로였다. 커피를 두 잔째 마시며 생각했다. ‘나는 도대체 언제부터 문제를 고치는 기계가 된 걸까.’

#     2. “주말이 무의미한 이유”

#     주말이 되면 침대에 눕는다. 몸은 쉬는데 머리는 여전히 돌아간다. 월요일 회의, 배포 일정, PR 코드 리뷰. 친구들이 여행 사진을 올려도 감흥이 없다. 나는 ‘좋아요’를 누르며, 진심으로 ‘좋다’고 느낀 적이 언제였는지 떠올린다. 어쩌면 나는 사는 게 아니라, 잠시 멈춘 프로그램처럼 대기 중인 건지도 모르겠다.

#     3. “커피와 대화”

#     회사 근처 카페에서 디자이너 민주랑 잠깐 얘기했다. “도윤 씨는 왜 개발자 됐어요?”라는 질문이 나를 멈추게 했다. 이유가 뭐였더라. 안정적이라서? 잘한다는 말 듣고 싶어서? 그 어떤 것도 지금의 나를 설명하지 못한다. 커피 향은 진했지만 맛은 느껴지지 않았다. 나는 아직, 나를 디버깅 중이다.

#     4. “퇴근 후의 공기”

#     오늘은 야근하지 않기로 했다. 8시에 퇴근해 지하철역까지 걸었다. 저녁 공기가 차가웠다. 휴대폰을 보지 않고 그냥 걸었다. 사람들의 목소리, 불빛, 바람—all alive. 문득 생각했다. 이건 내가 만든 세상이 아니라, 내가 놓치고 있던 세상이다. 코드 밖의 삶이 이렇게도 선명할 줄이야.

#     5. “새벽 3시의 Git Commit”

#     새벽 3시, 혼자 코드를 리팩토링하다가 문득 ‘이게 내 인생의 리팩토링도 되면 좋겠다’는 생각이 들었다. 복잡하게 얽힌 변수들처럼 내 감정도 정리되지 않는다. 그래도 이 시간을 좋아한다. 조용하고, 아무도 나를 호출하지 않는다. 커밋 메시지를 쓴다: “fix: minor issues and a piece of my mind.”

#     6. “작은 시작”

#     오늘은 아무것도 대단한 일을 하지 않았다. 대신 출근 전에 작은 식물을 샀다. 책상 옆에 두니 이상하게 집중이 잘됐다. 매일 같은 코드지만, 내 옆에서 누군가 자란다는 게 위로가 된다. 식물처럼 나도 언젠가 조금씩 자라겠지. 완벽한 코드는 없듯, 완벽한 삶도 없다. 다만 실행 중이면 된다.

#     1. “결정의 날”

#     오늘 사직서를 냈다. 손이 덜덜 떨렸다. 팀장은 놀라지도 않았다. “그럴 줄 알았어요.” 그 말이 이상하게 따뜻했다. 퇴근길에 하늘을 보니 구름이 낮게 깔려 있었다. 불안하지만, 묘하게 가볍다. 그동안 ‘해야만 하는 일’에 묶여 있었는데, 이제야 내 인생의 커서를 옮긴 기분이다. 백스페이스는 아니고, 그냥 새 줄.

#     2. “출근하지 않는 아침”

#     알람 없이 눈을 떴다. 8시. 평소라면 이미 지하철 안이었을 시간. 커튼을 걷으니 햇살이 낯설었다. 커피를 천천히 내리고, 아무 데도 가지 않는 하루를 시작했다. 초반엔 공허했지만, 금세 마음 한쪽이 말랑해졌다. 회사가 없어도 세상은 돌아간다. 그리고 나도, 아직 살아 있다.

#     3. “노트북을 닫고”

#     오늘 처음으로 코드 에디터를 열지 않았다. 대신 책을 읽었다. 개발과 상관없는 인문서였다. 문장을 따라가다가 문득 울컥했다. ‘너는 효율적이지만, 행복하지 않다.’ 내 얘기였다. 사람들은 늘 더 빠르고 정확하길 원하지만, 나는 이제 느리게라도 제대로 살고 싶다. 버그 없는 삶보다 의미 있는 삶을 원한다.

#     4. “낯선 카페, 낯선 나”

#     프리랜서 친구가 일하는 카페에 놀러 갔다. 노트북을 펴고 작은 프로젝트를 시작했다. 급하지도, 평가받지도 않는다. 내 손끝에서 무언가 ‘만들어지는 느낌’이 오랜만에 돌아왔다. 돈은 안 되지만, 재미는 있다. 회사 밖 세상에도 ‘일’이 아니라 ‘삶’으로 코드를 짜는 사람들이 있었다.

#     5. “바다 앞에서”

#     며칠 전, 혼자 속초로 갔다. 파도 소리를 들으며 생각했다. 나는 늘 뭔가를 만들어야만 존재한다고 믿었지만, 아무것도 하지 않아도 세상은 충분히 아름답다. 물결이 반복되듯, 나의 불안도 언젠간 잦아들겠지. 파도에 발을 담그며 속삭였다. “다시 시작하자. 천천히.”

#     6. “리셋”

#     다시 서울로 돌아왔다. 예전처럼 회사로 향하지 않고, 집 근처 공유오피스에 간다. 작은 스타트업을 준비하는 친구들과 함께 새로운 걸 만들어보기로 했다. 이번엔 속도보다 방향이다. 커피를 마시며 다짐했다. 완벽하지 않아도 괜찮다. 중요한 건 계속 ‘실행 중’이라는 것. 인생의 새로운 commit이 시작된다.

#     1. “다시 시작된 코드”

#     오늘은 우리 팀 첫 서비스의 베타 오픈 날이다. 세 명이서 만든 앱이라 허술한 구석이 많다. 그래도 화면에 내가 만든 로직이 살아 움직일 때의 짜릿함은 잊을 수 없다. 퇴사 후 처음 느낀 ‘일의 설렘’. 누가 시켜서 하는 일이 아니라, 내가 만들고 싶어서 만든 일. 긴 밤이었지만, 이번엔 피곤보다 자부심이 남았다.

#     2. “갈등”

#     디자이너 민주와 또 다퉜다. ‘기능보다 감성’ vs ‘안정성보다 완성도’. 예전 회사에서도 이런 논쟁이 있었는데, 이번엔 달랐다. 싸움 뒤에 남는 건 냉랭함이 아니라, 서로 진심으로 더 나은 걸 만들고 싶은 마음이었다. 우리는 아직 서툴고, 그래서 불편하다. 하지만 이 불편함이 진짜 협업의 시작일지도 모르겠다.

#     3. “돈 이야기”

#     투자 미팅에서 거절당했다. 피드백은 “시장성이 약하다.”
#     돌아오는 길에 잠깐 멍해졌다. ‘우리가 만든 게 정말 의미가 있나?’
#     하지만 생각해보면, 처음부터 돈 때문에 시작한 건 아니었다.
#     민주가 말했다. “우리만이라도 써도 좋잖아요.”
#     그 말에 웃었다. 세상에 이 앱을 단 세 명만 써도, 그게 우리 세 명이라면 괜찮다고 느껴졌다.

#     4. “야근의 의미”

#     새벽까지 코드를 짜다가 잠시 멈췄다.
#     창밖 달빛이 책상 위 키보드에 닿았다.
#     예전 회사에선 야근이 고통이었는데, 지금은 몰입이다.
#     힘들지만 억지로가 아니라 스스로 선택한 피로다.
#     나는 여전히 완벽한 개발자는 아니지만, 적어도 지금은 내가 내 일을 사랑한다.
#     그걸로 충분하다.

#     5. “하루의 끝에서”

#     오늘 서비스에 첫 유저 리뷰가 달렸다.
#     “요즘 힘들었는데, 이 앱 덕분에 하루가 좀 나아졌어요.”
#     단 한 줄인데, 모든 피로가 사라졌다.
#     우리가 만든 게 누군가의 하루를 바꿨다는 사실.
#     그게 결국 내가 개발자가 된 이유였던 것 같다.
#     이 감정은 어떤 성과 지표로도 설명할 수 없다.

#     6. “commit: keep going”

#     가끔 여전히 불안하다. 이 길이 맞는지 모르겠고, 내 코드가 엉망일 때마다 자책한다.
#     하지만 예전처럼 도망치지 않는다.
#     완벽하지 않은 채로도 계속 나아가는 법을 배웠다.
#     오늘의 커밋 메시지는 단순하다.
#     commit: keep going
#     인생도, 코드도. 아직 개발 중이니까.
#     """
    
#     answers = predict_personality_answers(sample_conversation)
#     print(f"예측된 120개 응답 길이: {len(answers)}")
#     print(answers)  # 앞부분만 미리보기